<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Revenue Architect | Panoramica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        'pano-bg': '#030303', 'pano-panel': '#0A0A0A', 'pano-card': '#0F0F0F',
                        'pano-lime': '#CDFF00', 'pano-lime-soft': '#B8E600',
                        'pano-grey': '#888888', 'pano-grey-light': '#A0A0A0',
                        'pano-border': '#1A1A1A', 'pano-border-hover': '#2A2A2A',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'glow': '0 0 40px rgba(205, 255, 0, 0.15)',
                        'glow-sm': '0 0 20px rgba(205, 255, 0, 0.1)',
                        'card': '0 4px 24px rgba(0, 0, 0, 0.4)',
                    }
                }
            }
        }
    </script>
    
    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { background-color: #030303; color: white; display: flex; flex-direction: column; overflow: hidden; font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11'; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #2A2A2A; border-radius: 3px; }
        
        .prose { font-size: 0.9375rem; line-height: 1.7; }
        .prose p { margin-bottom: 1em; color: #E0E0E0; }
        .prose p:last-child { margin-bottom: 0; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose em { color: #B0B0B0; }
        .prose ul, .prose ol { padding-left: 1.5em; margin: 1em 0; color: #C0C0C0; }
        .prose li { margin-bottom: 0.5em; }
        .prose li::marker { color: #CDFF00; }
        .prose a { color: #CDFF00; text-decoration: underline; text-underline-offset: 2px; }
        .prose a:hover { color: #fff; }
        .prose code { background: #1A1A1A; padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.85em; font-family: 'JetBrains Mono', monospace; }
        .prose h1, .prose h2, .prose h3 { color: #fff; font-weight: 600; margin: 1.5em 0 0.75em; }
        .prose h1 { font-size: 1.5em; } .prose h2 { font-size: 1.25em; } .prose h3 { font-size: 1.1em; }
        .prose blockquote { border-left: 3px solid #CDFF00; padding-left: 1em; margin: 1em 0; color: #A0A0A0; font-style: italic; }
        .prose hr { border: none; border-top: 1px solid #2A2A2A; margin: 1.5em 0; }
        
        @keyframes message-in { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .msg-anim { animation: message-in 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes typing-dot { 0%, 60%, 100% { opacity: 0.3; transform: scale(1); } 30% { opacity: 1; transform: scale(1.2); } }
        .typing-dot { animation: typing-dot 1.4s infinite; width: 6px; height: 6px; background: #CDFF00; border-radius: 50%; }
        .typing-dot:nth-child(2) { animation-delay: 0.15s; }
        .typing-dot:nth-child(3) { animation-delay: 0.3s; }
        
        .btn-option { position: relative; overflow: hidden; }
        .btn-option::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(205, 255, 0, 0.05), transparent); transition: left 0.5s ease; }
        .btn-option:hover::before { left: 100%; }
        
        /* Phase tracker */
        .phase-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid #333; transition: all 0.3s; }
        .phase-dot.done { background: #22c55e; border-color: #22c55e; }
        .phase-dot.active { background: #CDFF00; border-color: #CDFF00; box-shadow: 0 0 8px rgba(205,255,0,0.4); }
        .phase-dot.pending { background: transparent; border-color: #333; }
        .phase-line { height: 2px; width: 20px; transition: background 0.3s; }
        .phase-line.done { background: #22c55e; }
        .phase-line.active { background: linear-gradient(90deg, #22c55e, #CDFF00); }
        .phase-line.pending { background: #1A1A1A; }
        
        input:-webkit-autofill { -webkit-box-shadow: 0 0 0 30px #0F0F0F inset !important; -webkit-text-fill-color: white !important; }
    </style>
</head>
<body class="selection:bg-pano-lime selection:text-black">

    <!-- Context Modal -->
    <div id="context-modal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl flex items-center justify-center p-4 transition-all duration-500">
        <div class="bg-pano-card border border-pano-border w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden relative">
            <div class="absolute top-0 right-0 w-64 h-64 bg-pano-lime/5 blur-[80px] rounded-full pointer-events-none"></div>
            <div class="relative z-10 p-8">
                <div class="flex items-start gap-4 mb-8">
                    <div class="w-12 h-12 bg-pano-lime/10 border border-pano-lime/30 rounded-xl flex items-center justify-center text-pano-lime shrink-0">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5m.75-9l3-3 2.148 2.148A12.061 12.061 0 0116.5 7.605"></path></svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-1">Initialize Analysis</h2>
                        <p class="text-pano-grey text-sm">Provide your digital footprint for a personalized revenue diagnostic.</p>
                    </div>
                </div>
                <form id="context-form" onsubmit="handleContextSubmit(event)" class="space-y-5">
                    <div>
                        <label class="block text-xs font-medium text-pano-grey-light uppercase tracking-wider mb-2">Company Website</label>
                        <input type="url" id="company-website" required placeholder="https://yourcompany.com" class="w-full bg-pano-panel border border-pano-border rounded-xl px-4 py-3.5 text-white text-sm focus:border-pano-lime focus:outline-none transition-all placeholder:text-gray-600">
                        <span id="website-error" class="text-red-400 text-xs hidden mt-2 block">Enter a valid URL</span>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-pano-grey-light uppercase tracking-wider mb-2">Business Description <span class="text-pano-lime text-[10px] ml-1">(IMPORTANT)</span></label>
                        <textarea id="company-description" rows="2" placeholder="Ex: B2B SaaS for agency reporting automation..." class="w-full bg-pano-panel border border-pano-border rounded-xl px-4 py-3.5 text-white text-sm focus:border-pano-lime focus:outline-none transition-all placeholder:text-gray-600 resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-pano-grey-light uppercase tracking-wider mb-2">LinkedIn <span class="text-pano-grey">(Optional)</span></label>
                        <input type="url" id="company-linkedin" placeholder="https://linkedin.com/company/..." class="w-full bg-pano-panel border border-pano-border rounded-xl px-4 py-3.5 text-white text-sm focus:border-pano-lime focus:outline-none transition-all placeholder:text-gray-600">
                    </div>
                    <div class="pt-4 flex gap-3">
                        <button type="button" onclick="closeModalAndStartDemo()" class="flex-1 bg-transparent border border-pano-border text-pano-grey font-semibold py-4 rounded-xl hover:text-white hover:bg-white/5 transition-all">Demo</button>
                        <button type="submit" id="submit-context" class="flex-[2] bg-pano-lime text-black font-bold py-4 rounded-xl hover:bg-pano-lime-soft transition-all shadow-glow flex items-center justify-center gap-2 group">
                            <span>Start Analysis</span>
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="group-hover:translate-x-1 transition-transform"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"></path></svg>
                        </button>
                    </div>
                </form>
                <p class="text-center text-[11px] text-gray-600 mt-6">Your data is analyzed in real-time and never stored.</p>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="h-16 border-b border-pano-border bg-pano-bg/90 backdrop-blur-md flex items-center justify-between px-4 md:px-6 z-40 shrink-0">
        <div class="flex items-center gap-3 md:gap-4">
            <div class="flex items-center gap-3">
                <div class="w-2 h-8 bg-pano-lime rounded-full"></div>
                <div>
                    <h1 class="font-bold text-sm tracking-wide text-white">REVENUE ARCHITECT</h1>
                    <div class="flex items-center gap-2">
                        <span id="status-indicator" class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span>
                        <span id="status-text" class="text-[10px] text-pano-grey font-mono tracking-wider">READY</span>
                    </div>
                </div>
            </div>
            
            <!-- Phase Tracker -->
            <div id="phase-tracker" class="hidden md:flex items-center ml-6 pl-6 border-l border-pano-border gap-0.5">
                <div class="flex items-center">
                    <div class="flex flex-col items-center">
                        <div id="dot-welcome" class="phase-dot pending"></div>
                        <span class="text-[7px] text-pano-grey mt-1 font-mono">INIT</span>
                    </div>
                    <div id="line-1" class="phase-line pending mx-0.5"></div>
                    <div class="flex flex-col items-center">
                        <div id="dot-company" class="phase-dot pending"></div>
                        <span class="text-[7px] text-pano-grey mt-1 font-mono">CO</span>
                    </div>
                    <div id="line-2" class="phase-line pending mx-0.5"></div>
                    <div class="flex flex-col items-center">
                        <div id="dot-gtm" class="phase-dot pending"></div>
                        <span class="text-[7px] text-pano-grey mt-1 font-mono">GTM</span>
                    </div>
                    <div id="line-3" class="phase-line pending mx-0.5"></div>
                    <div class="flex flex-col items-center">
                        <div id="dot-sales" class="phase-dot pending"></div>
                        <span class="text-[7px] text-pano-grey mt-1 font-mono">SALES</span>
                    </div>
                    <div id="line-4" class="phase-line pending mx-0.5"></div>
                    <div class="flex flex-col items-center">
                        <div id="dot-diagnosis" class="phase-dot pending"></div>
                        <span class="text-[7px] text-pano-grey mt-1 font-mono">DX</span>
                    </div>
                    <div id="line-5" class="phase-line pending mx-0.5"></div>
                    <div class="flex flex-col items-center">
                        <div id="dot-finish" class="phase-dot pending"></div>
                        <span class="text-[7px] text-pano-grey mt-1 font-mono">DONE</span>
                    </div>
                </div>
                
                <!-- Score -->
                <div class="flex items-center gap-2 ml-4 pl-4 border-l border-pano-border">
                    <div class="relative w-9 h-9">
                        <svg class="w-9 h-9 transform -rotate-90" viewBox="0 0 36 36">
                            <circle cx="18" cy="18" r="15" fill="none" stroke="#1A1A1A" stroke-width="3"/>
                            <circle id="score-circle" cx="18" cy="18" r="15" fill="none" stroke="#CDFF00" stroke-width="3" stroke-dasharray="0 94.2" stroke-linecap="round" class="transition-all duration-700"/>
                        </svg>
                        <span id="score-number" class="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white">0</span>
                    </div>
                    <div class="text-[9px] font-mono leading-tight">
                        <div class="text-pano-grey">CONFIDENCE</div>
                        <div id="score-status" class="text-pano-lime">INIT</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <span id="turn-counter" class="text-[10px] font-mono text-pano-grey hidden">T0</span>
            <button onclick="location.reload()" class="text-xs font-medium text-pano-grey hover:text-white transition-colors border border-pano-border px-3 py-2 rounded-lg hover:bg-white/5">Reset</button>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-[2px] bg-pano-panel"><div id="ai-progress" class="h-full bg-gradient-to-r from-pano-lime to-pano-lime-soft transition-all duration-700" style="width:0%"></div></div>

    <!-- Chat Area -->
    <main id="chat-history" class="flex-1 overflow-y-auto custom-scrollbar scroll-smooth">
        <div class="max-w-3xl mx-auto py-8 px-4 md:px-0 min-h-full flex flex-col justify-end">
            <div id="dynamic-content" class="space-y-6"></div>
            <div class="h-36"></div>
        </div>
    </main>

    <!-- Bottom Controls -->
    <div class="shrink-0 bg-gradient-to-t from-pano-bg via-pano-bg/95 to-transparent pt-12 pb-6 px-4 z-30">
        <div class="max-w-3xl mx-auto space-y-4">
            <div id="ai-options" class="flex flex-col gap-2"></div>
            
            <div id="input-bar" class="relative group hidden opacity-0 transition-opacity duration-500">
                <div id="file-preview" class="absolute -top-14 left-0 bg-pano-card border border-pano-border px-4 py-2.5 rounded-xl hidden shadow-card">
                    <span class="text-xs text-pano-lime font-mono" id="file-name"></span>
                    <button onclick="clearFile()" class="text-gray-500 hover:text-white ml-2">✕</button>
                </div>
                <div class="bg-pano-card border border-pano-border rounded-xl flex items-center p-2 shadow-card focus-within:border-pano-lime/50 transition-all">
                    <input type="file" id="file-upload" class="hidden" accept="image/*,application/pdf" onchange="handleFileSelect(this)">
                    <button onclick="document.getElementById('file-upload').click()" class="p-3 text-gray-500 hover:text-pano-grey-light transition-colors rounded-lg hover:bg-white/5">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13"></path></svg>
                    </button>
                    <input type="text" id="ai-text-input" class="flex-1 bg-transparent border-none text-white text-sm px-3 focus:ring-0 focus:outline-none placeholder:text-gray-600 h-10" placeholder="Type your response...">
                    <button onclick="handleTextSubmit()" class="p-2.5 bg-pano-lime text-black rounded-lg hover:bg-pano-lime-soft transition-all shadow-glow-sm">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"></path></svg>
                    </button>
                </div>
            </div>
            <div class="text-center pt-2"><p class="text-[10px] text-gray-700 font-mono tracking-widest">PANORAMICA v6.0 • MULTI-AGENT</p></div>
        </div>
    </div>

    <script>
        const API_URL = "/api/chat";
        const REPORT_API_URL = "/api/report";
        const PHASES = ['welcome','company','gtm','sales','diagnosis','pre_finish','finish'];
        const PHASE_DOTS = { welcome:'dot-welcome', company:'dot-company', gtm:'dot-gtm', sales:'dot-sales', diagnosis:'dot-diagnosis', pre_finish:'dot-finish', finish:'dot-finish', add_context:'dot-diagnosis' };

        // State
        let conversationHistory = [];
        let sessionData = null;
        let currentAttachment = null;
        let isProcessing = false;
        let diagnosticData = {};

        // DOM
        const chatMain = document.getElementById('chat-history');
        const dynamicContent = document.getElementById('dynamic-content');
        const optionsContainer = document.getElementById('ai-options');
        const inputBar = document.getElementById('input-bar');
        const progressBar = document.getElementById('ai-progress');
        const textInput = document.getElementById('ai-text-input');

        // Utils
        function isValidURL(s) { try { const u = new URL(s); return u.protocol.startsWith('http'); } catch { return false; } }
        function sanitize(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function scroll() { requestAnimationFrame(() => chatMain.scrollTo({ top: chatMain.scrollHeight, behavior: 'smooth' })); }

        function setStatus(ok, msg) {
            document.getElementById('status-indicator').className = `w-1.5 h-1.5 ${ok ? 'bg-emerald-500' : 'bg-red-500 animate-pulse'} rounded-full`;
            const st = document.getElementById('status-text');
            st.textContent = msg || (ok ? 'READY' : 'ERROR');
            st.className = `text-[10px] ${ok ? 'text-pano-grey' : 'text-red-400'} font-mono tracking-wider`;
        }

        function updatePhaseTracker(phase, confidence) {
            document.getElementById('phase-tracker').classList.remove('hidden');
            const idx = PHASES.indexOf(phase === 'add_context' ? 'diagnosis' : phase);
            
            ['welcome','company','gtm','sales','diagnosis','finish'].forEach((p, i) => {
                const dot = document.getElementById(`dot-${p === 'pre_finish' ? 'finish' : p}`);
                if (!dot) return;
                const phaseIdx = p === 'finish' ? 5 : PHASES.indexOf(p);
                dot.classList.remove('done','active','pending');
                dot.classList.add(phaseIdx < idx ? 'done' : phaseIdx === idx ? 'active' : 'pending');
            });
            
            for (let i = 1; i <= 5; i++) {
                const line = document.getElementById(`line-${i}`);
                if (!line) continue;
                line.classList.remove('done','active','pending');
                line.classList.add(i < idx ? 'done' : i === idx ? 'active' : 'pending');
            }
            
            // Confidence
            const score = confidence?.total || 0;
            const circ = 94.2;
            document.getElementById('score-circle').setAttribute('stroke-dasharray', `${(score/100)*circ} ${circ}`);
            document.getElementById('score-number').textContent = score;
            const ss = document.getElementById('score-status');
            ss.textContent = score >= 70 ? 'READY' : score >= 40 ? 'BUILDING' : 'GATHERING';
            ss.className = score >= 70 ? 'text-green-400' : score >= 40 ? 'text-yellow-400' : 'text-pano-lime';
            
            progressBar.style.width = `${Math.max(score, (idx / 6) * 100)}%`;
            
            const tc = document.getElementById('turn-counter');
            tc.classList.remove('hidden');
            tc.textContent = `T${sessionData?.turnCount || 0}`;
        }

        function showTyping() {
            const d = document.createElement('div');
            d.id = 'typing-indicator';
            d.className = 'flex gap-4 msg-anim';
            d.innerHTML = `<div class="w-9 h-9 rounded-xl bg-pano-panel border border-pano-border flex items-center justify-center shrink-0"><span class="text-pano-lime font-mono text-xs font-medium">RA</span></div><div class="flex gap-1.5 items-center bg-pano-card border border-pano-border px-6 py-4 rounded-2xl"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            dynamicContent.appendChild(d);
            scroll();
        }
        function hideTyping() { document.getElementById('typing-indicator')?.remove(); }

        function showLoading(msg) {
            optionsContainer.innerHTML = `<div class="w-full bg-pano-card border border-pano-border p-5 rounded-xl flex items-center gap-4"><div class="w-5 h-5 border-2 border-pano-lime border-t-transparent rounded-full animate-spin"></div><span class="text-xs font-mono text-pano-lime uppercase tracking-widest">${msg}</span></div>`;
        }

        function addUserMsg(text) {
            const d = document.createElement('div');
            d.className = 'flex gap-4 flex-row-reverse msg-anim';
            d.innerHTML = `<div class="w-9 h-9 rounded-xl bg-pano-lime flex items-center justify-center shrink-0"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="text-black"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"></path></svg></div><div class="max-w-[80%]"><div class="text-sm bg-pano-panel border border-pano-border p-4 rounded-2xl rounded-tr-md text-white">${sanitize(text)}</div></div>`;
            dynamicContent.appendChild(d);
            scroll();
        }

        function addAIMsg(text) {
            if (!text) return;
            const d = document.createElement('div');
            d.className = 'flex gap-4 msg-anim';
            let html;
            try { marked.setOptions({ breaks: true, gfm: true }); html = marked.parse(text); } catch { html = sanitize(text); }
            d.innerHTML = `<div class="w-9 h-9 rounded-xl bg-pano-panel border border-pano-border flex items-center justify-center shrink-0"><span class="text-pano-lime font-mono text-xs font-medium">RA</span></div><div class="flex-1 max-w-[85%]"><div class="prose bg-pano-card border border-pano-border p-5 rounded-2xl rounded-tl-md shadow-card">${html}</div></div>`;
            dynamicContent.appendChild(d);
            scroll();
        }

        // API Call
        async function callAPI(payload) {
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const ctrl = new AbortController();
                    const timeout = setTimeout(() => ctrl.abort(), 60000);
                    const resp = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: ctrl.signal
                    });
                    clearTimeout(timeout);
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    return await resp.json();
                } catch (e) {
                    if (attempt === 2) throw e;
                    await new Promise(r => setTimeout(r, 1000 * (attempt + 1)));
                }
            }
        }

        // Modal
        function closeModalAndStartDemo() {
            document.getElementById('context-modal').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('context-modal').classList.add('hidden');
                addAIMsg("**Demo Mode**\n\nI'm the Revenue Architect. Let's diagnose your revenue bottlenecks.");
                renderOptions([{ key: 'start', label: 'Begin Revenue Diagnostic' }], true);
            }, 400);
        }

        async function handleContextSubmit(e) {
            e.preventDefault();
            const website = document.getElementById('company-website').value.trim();
            const description = document.getElementById('company-description').value.trim();
            const linkedin = document.getElementById('company-linkedin').value.trim();
            
            if (!isValidURL(website)) { document.getElementById('website-error').classList.remove('hidden'); return; }
            document.getElementById('website-error').classList.add('hidden');

            const btn = document.getElementById('submit-context');
            btn.disabled = true;
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin"></div><span>Analyzing...</span>';
            
            document.getElementById('context-modal').style.opacity = '0';
            setTimeout(() => document.getElementById('context-modal').classList.add('hidden'), 400);
            
            addAIMsg("**Initializing**\n\nScanning your digital footprint...");
            showLoading('SCANNING WEBSITE...');
            setStatus(true, 'SCANNING');

            try {
                diagnosticData = { website, description, linkedin };
                
                const data = await callAPI({
                    choice: 'SNAPSHOT_INIT',
                    history: [],
                    contextData: diagnosticData,
                    sessionData: null
                });
                
                sessionData = data.session_data;
                conversationHistory.push({ role: 'assistant', content: JSON.stringify(data) });
                
                updatePhaseTracker(data.current_phase, data.confidence_state);
                renderTurn(data);
                setStatus(true, 'READY');
            } catch (err) {
                console.error(err);
                setStatus(false, 'FAILED');
                optionsContainer.innerHTML = `<button onclick="location.reload()" class="w-full text-red-400 border border-red-900/50 bg-red-900/10 p-5 rounded-xl">Analysis failed. Click to retry.</button>`;
            }
        }

        // Main interaction handler
        async function handleOption(key, label) {
            if (isProcessing) return;
            if (key === 'download_report' || key === 'generate_report') { downloadReport(); return; }
            
            isProcessing = true;
            const displayLabel = label || key;
            addUserMsg(displayLabel);
            showTyping();
            showLoading('PROCESSING...');
            inputBar.classList.add('opacity-50', 'pointer-events-none');
            
            try {
                const data = await callAPI({
                    choice: key,
                    history: conversationHistory,
                    sessionData: sessionData,
                    contextData: diagnosticData,
                    attachment: currentAttachment
                });
                
                clearFile();
                sessionData = data.session_data;
                
                conversationHistory.push({ role: 'user', content: `User: ${key}` });
                conversationHistory.push({ role: 'assistant', content: JSON.stringify(data) });
                
                hideTyping();
                updatePhaseTracker(data.current_phase, data.confidence_state);
                renderTurn(data);
                setStatus(true, 'READY');
            } catch (err) {
                console.error(err);
                hideTyping();
                setStatus(false, 'ERROR');
                optionsContainer.innerHTML = `<div class="text-red-400 p-5 text-center text-sm bg-red-900/10 border border-red-900/50 rounded-xl"><span>Connection error</span><br><button onclick="handleOption('${key}','${displayLabel}')" class="underline mt-2">Retry</button></div>`;
            } finally {
                isProcessing = false;
            }
        }

        async function handleTextSubmit() {
            const text = textInput.value.trim();
            if (!text || isProcessing) return;
            textInput.value = '';
            await handleOption(text, text);
        }

        function renderTurn(data) {
            optionsContainer.innerHTML = '';
            inputBar.classList.remove('opacity-50', 'pointer-events-none');
            
            addAIMsg(data.message || "Processing...");
            renderOptions(data.options, data.allow_text !== false && data.mode !== 'buttons');
        }

        function renderOptions(options, showInput = true) {
            optionsContainer.innerHTML = '';
            
            if (!options || options.length === 0) {
                options = [{ key: 'continue', label: 'Continue' }];
            }

            options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.style.animationDelay = `${idx * 0.08}s`;
                btn.onclick = () => handleOption(opt.key, opt.label);
                
                if (opt.key === 'download_report' || opt.key === 'generate_report') {
                    btn.className = 'msg-anim w-full bg-pano-lime text-black border-2 border-pano-lime p-5 rounded-xl font-bold flex items-center justify-between shadow-glow hover:bg-pano-lime-soft hover:scale-[1.01] transition-all';
                    btn.innerHTML = `<div class="flex items-center gap-3"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg><span>${opt.label}</span></div><span class="text-sm opacity-70">PDF</span>`;
                } else {
                    btn.className = 'msg-anim btn-option w-full text-left bg-pano-card border border-pano-border hover:border-pano-lime/50 p-4 rounded-xl transition-all group flex items-center justify-between';
                    btn.innerHTML = `<span class="text-sm font-medium text-white">${opt.label}</span><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" class="text-pano-grey group-hover:text-pano-lime group-hover:translate-x-1 transition-all shrink-0 ml-3"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"></path></svg>`;
                }
                optionsContainer.appendChild(btn);
            });

            if (showInput) {
                inputBar.classList.remove('hidden');
                setTimeout(() => { inputBar.classList.remove('opacity-0'); textInput.focus(); }, 100);
            } else {
                inputBar.classList.add('hidden', 'opacity-0');
            }
            scroll();
        }

        // Report
        async function downloadReport() {
            if (isProcessing) return;
            isProcessing = true;
            showLoading('GENERATING REPORT...');
            setStatus(true, 'GENERATING');
            
            try {
                const resp = await fetch(REPORT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: conversationHistory, sessionData, diagnosticData })
                });
                if (!resp.ok) throw new Error('Report failed');
                const data = await resp.json();
                
                if (data.pdf_base64) {
                    const bytes = atob(data.pdf_base64);
                    const arr = new Uint8Array(bytes.length);
                    for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
                    const blob = new Blob([arr], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = data.filename || 'Growth_Plan.pdf';
                    a.click(); URL.revokeObjectURL(url);
                } else if (data.report) {
                    const html = marked.parse(data.report);
                    const c = document.createElement('div');
                    c.innerHTML = `<div style="font-family:Arial;padding:40px;max-width:800px">${html}</div>`;
                    c.style.cssText = 'position:absolute;left:-9999px';
                    document.body.appendChild(c);
                    await html2pdf().set({ margin: 15, filename: 'Strategic_Growth_Plan.pdf', html2canvas: { scale: 2 }, jsPDF: { format: 'a4' } }).from(c).save();
                    document.body.removeChild(c);
                }
                
                addAIMsg("✅ **Report Generated!** Your Strategic Growth Plan has been downloaded.");
                renderOptions([{ key: 'restart', label: 'Start New Diagnostic' }], false);
                updatePhaseTracker('finish', { total: 100 });
                setStatus(true, 'COMPLETE');
            } catch (err) {
                console.error(err);
                setStatus(false, 'FAILED');
                optionsContainer.innerHTML = `<div class="text-red-400 p-5 text-center bg-red-900/10 border border-red-900/50 rounded-xl">Report generation failed. <button onclick="downloadReport()" class="underline ml-1">Retry</button></div>`;
            } finally {
                isProcessing = false;
            }
        }

        // File handling
        function clearFile() { currentAttachment = null; document.getElementById('file-upload').value = ''; document.getElementById('file-preview').classList.add('hidden'); }
        function handleFileSelect(input) {
            const f = input.files[0]; if (!f) return;
            if (f.size > 15*1024*1024) { alert('File too large (max 15MB)'); return; }
            const preview = document.getElementById('file-preview');
            preview.classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = (e) => {
                currentAttachment = { mime_type: f.type, data: e.target.result.split(',')[1], name: f.name };
                document.getElementById('file-name').textContent = f.name.toUpperCase();
            };
            reader.readAsDataURL(f);
        }

        // Events
        textInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleTextSubmit(); } });
        window.addEventListener('beforeunload', e => { if (conversationHistory.length > 2) { e.preventDefault(); e.returnValue = ''; } });
        
        // Initial button
        renderOptions([{ key: 'start', label: 'Begin Revenue Diagnostic' }], false);
    </script>
</body>
</html>
