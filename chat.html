<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Revenue Architect | Panoramica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        'pano-bg': '#030303',
                        'pano-panel': '#0A0A0A',
                        'pano-card': '#0F0F0F',
                        'pano-lime': '#CDFF00',
                        'pano-lime-soft': '#B8E600',
                        'pano-grey': '#888888',
                        'pano-grey-light': '#A0A0A0',
                        'pano-border': '#1A1A1A',
                        'pano-border-hover': '#2A2A2A',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'glow': '0 0 40px rgba(205, 255, 0, 0.15)',
                        'glow-sm': '0 0 20px rgba(205, 255, 0, 0.1)',
                        'card': '0 4px 24px rgba(0, 0, 0, 0.4)',
                    }
                }
            }
        }
    </script>
    
    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { 
            background-color: #030303; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #2A2A2A; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #3A3A3A; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .prose { font-size: 0.9375rem; line-height: 1.7; }
        .prose p { margin-bottom: 1em; color: #E0E0E0; }
        .prose p:last-child { margin-bottom: 0; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose em { color: #B0B0B0; }
        .prose ul, .prose ol { padding-left: 1.5em; margin: 1em 0; color: #C0C0C0; }
        .prose li { margin-bottom: 0.5em; }
        .prose li::marker { color: #CDFF00; }
        .prose a { color: #CDFF00; text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.2s; }
        .prose a:hover { border-bottom-color: #CDFF00; }
        .prose code { background: #1A1A1A; padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.85em; font-family: 'JetBrains Mono', monospace; }
        .prose h1, .prose h2, .prose h3 { color: #fff; font-weight: 600; margin: 1.5em 0 0.75em; }
        .prose h1 { font-size: 1.5em; }
        .prose h2 { font-size: 1.25em; }
        .prose h3 { font-size: 1.1em; }
        .prose blockquote { border-left: 3px solid #CDFF00; padding-left: 1em; margin: 1em 0; color: #A0A0A0; font-style: italic; }
        
        @keyframes message-in { 
            from { opacity: 0; transform: translateY(12px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .msg-anim { animation: message-in 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes typing-dot {
            0%, 60%, 100% { opacity: 0.3; transform: scale(1); }
            30% { opacity: 1; transform: scale(1.2); }
        }
        .typing-dot { animation: typing-dot 1.4s infinite; width: 6px; height: 6px; background: #CDFF00; border-radius: 50%; }
        .typing-dot:nth-child(2) { animation-delay: 0.15s; }
        .typing-dot:nth-child(3) { animation-delay: 0.3s; }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .shimmer { background: linear-gradient(90deg, #1A1A1A 25%, #252525 50%, #1A1A1A 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fade-in 0.5s ease forwards; }
        
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #0F0F0F inset !important;
            -webkit-text-fill-color: white !important;
            caret-color: white;
        }
        
        .btn-option { position: relative; overflow: hidden; }
        .btn-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(205, 255, 0, 0.05), transparent);
            transition: left 0.5s ease;
        }
        .btn-option:hover::before { left: 100%; }
        
        .phase-step { transition: all 0.3s ease; }
        .phase-step.active { color: #CDFF00; }
        .phase-step.completed { color: #22c55e; }
        .phase-step.pending { color: #888888; }
        
        .phase-connector { height: 2px; transition: background-color 0.3s ease; }
        .phase-connector.completed { background-color: #22c55e; }
        .phase-connector.active { background: linear-gradient(90deg, #22c55e, #CDFF00); }
        .phase-connector.pending { background-color: #1A1A1A; }
        
        .glass { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .focus-ring:focus { outline: none; box-shadow: 0 0 0 2px #030303, 0 0 0 4px rgba(205, 255, 0, 0.5); }
    </style>
</head>
<body class="selection:bg-pano-lime selection:text-black">

    <!-- Context Modal -->
    <div id="context-modal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl flex items-center justify-center p-4 transition-all duration-500">
        <div class="bg-pano-card border border-pano-border w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden relative">
            <div class="absolute top-0 right-0 w-64 h-64 bg-pano-lime/5 blur-[80px] rounded-full pointer-events-none"></div>
            <div class="absolute bottom-0 left-0 w-48 h-48 bg-pano-lime/3 blur-[60px] rounded-full pointer-events-none"></div>
            
            <div class="relative z-10 p-8">
                <div class="flex items-start gap-4 mb-8">
                    <div class="w-12 h-12 bg-pano-lime/10 border border-pano-lime/30 rounded-xl flex items-center justify-center text-pano-lime shrink-0">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5m.75-9l3-3 2.148 2.148A12.061 12.061 0 0116.5 7.605"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-1">Initialize Analysis</h2>
                        <p class="text-pano-grey text-sm leading-relaxed">
                            Provide your digital footprint for a personalized revenue diagnostic.
                        </p>
                    </div>
                </div>

                <form id="context-form" onsubmit="handleContextSubmit(event)" class="space-y-5">
                    <div>
                        <label class="block text-xs font-medium text-pano-grey-light uppercase tracking-wider mb-2">Company Website</label>
                        <input type="url" id="company-website" required placeholder="https://yourcompany.com" 
                               class="w-full bg-pano-panel border border-pano-border rounded-xl px-4 py-3.5 text-white text-sm focus:border-pano-lime focus:outline-none focus:ring-2 focus:ring-pano-lime/20 transition-all placeholder:text-gray-600">
                        <span id="website-error" class="text-red-400 text-xs hidden mt-2 block">Please enter a valid URL (https://...)</span>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-pano-grey-light uppercase tracking-wider mb-2">
                            Business Description <span class="text-pano-lime text-[10px] ml-1">(CRITICAL)</span>
                        </label>
                        <textarea id="company-description" rows="2" placeholder="Ex: B2B SaaS platform helping agencies automate reporting..." 
                               class="w-full bg-pano-panel border border-pano-border rounded-xl px-4 py-3.5 text-white text-sm focus:border-pano-lime focus:outline-none focus:ring-2 focus:ring-pano-lime/20 transition-all placeholder:text-gray-600 resize-none custom-scrollbar"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-pano-grey-light uppercase tracking-wider mb-2">LinkedIn Company Page <span class="text-pano-grey">(Optional)</span></label>
                        <input type="url" id="company-linkedin" placeholder="https://linkedin.com/company/..." 
                               class="w-full bg-pano-panel border border-pano-border rounded-xl px-4 py-3.5 text-white text-sm focus:border-pano-lime focus:outline-none focus:ring-2 focus:ring-pano-lime/20 transition-all placeholder:text-gray-600">
                    </div>

                    <div class="pt-4 flex gap-3">
                        <button type="button" onclick="closeModalAndStartDemo()" class="flex-1 bg-transparent border border-pano-border text-pano-grey font-semibold py-4 rounded-xl hover:text-white hover:border-pano-border-hover hover:bg-white/5 transition-all">
                            Demo Mode
                        </button>
                        <button type="submit" id="submit-context" class="flex-[2] bg-pano-lime text-black font-bold py-4 rounded-xl hover:bg-pano-lime-soft transition-all shadow-glow flex items-center justify-center gap-2 group">
                            <span>Start Analysis</span>
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="transform group-hover:translate-x-1 transition-transform">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"></path>
                            </svg>
                        </button>
                    </div>
                </form>

                <p class="text-center text-[11px] text-gray-600 mt-6">
                    Your data is analyzed in real-time and never stored.
                </p>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="h-16 border-b border-pano-border bg-pano-bg/90 backdrop-blur-md flex items-center justify-between px-6 z-40 shrink-0">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-2 h-8 bg-pano-lime rounded-full"></div>
                <div>
                    <h1 class="font-bold text-sm tracking-wide text-white">REVENUE ARCHITECT</h1>
                    <div class="flex items-center gap-2">
                        <span id="status-indicator" class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span>
                        <span id="status-text" class="text-[10px] text-pano-grey font-mono tracking-wider">READY</span>
                    </div>
                </div>
            </div>
            
            <!-- Phase Progress Display -->
            <div id="phase-display" class="hidden md:flex items-center gap-2 ml-8 pl-8 border-l border-pano-border">
                <div class="flex items-center gap-1">
                    <!-- Phase Steps -->
                    <div class="flex items-center">
                        <div id="phase-welcome" class="phase-step flex flex-col items-center px-2" title="Welcome">
                            <div class="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] font-bold">1</div>
                            <span class="text-[8px] mt-1 font-mono">INIT</span>
                        </div>
                        <div id="conn-1" class="phase-connector w-4 pending"></div>
                        
                        <div id="phase-company" class="phase-step flex flex-col items-center px-2 pending" title="Company Discovery">
                            <div class="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] font-bold">2</div>
                            <span class="text-[8px] mt-1 font-mono">CO</span>
                        </div>
                        <div id="conn-2" class="phase-connector w-4 pending"></div>
                        
                        <div id="phase-gtm" class="phase-step flex flex-col items-center px-2 pending" title="Go-to-Market">
                            <div class="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] font-bold">3</div>
                            <span class="text-[8px] mt-1 font-mono">GTM</span>
                        </div>
                        <div id="conn-3" class="phase-connector w-4 pending"></div>
                        
                        <div id="phase-sales" class="phase-step flex flex-col items-center px-2 pending" title="Sales Discovery">
                            <div class="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] font-bold">4</div>
                            <span class="text-[8px] mt-1 font-mono">SALES</span>
                        </div>
                        <div id="conn-4" class="phase-connector w-4 pending"></div>
                        
                        <div id="phase-diagnosis" class="phase-step flex flex-col items-center px-2 pending" title="Diagnosis">
                            <div class="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] font-bold">5</div>
                            <span class="text-[8px] mt-1 font-mono">DX</span>
                        </div>
                        <div id="conn-5" class="phase-connector w-4 pending"></div>
                        
                        <div id="phase-finish" class="phase-step flex flex-col items-center px-2 pending" title="Report">
                            <div class="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] font-bold">‚úì</div>
                            <span class="text-[8px] mt-1 font-mono">DONE</span>
                        </div>
                    </div>
                </div>
                
                <!-- Confidence Score -->
                <div class="flex items-center gap-2 ml-4 pl-4 border-l border-pano-border">
                    <div class="relative w-10 h-10">
                        <svg class="w-10 h-10 transform -rotate-90" viewBox="0 0 36 36">
                            <circle cx="18" cy="18" r="15" fill="none" stroke="#1A1A1A" stroke-width="3"/>
                            <circle id="score-circle" cx="18" cy="18" r="15" fill="none" stroke="#CDFF00" stroke-width="3" 
                                    stroke-dasharray="0 94.2" stroke-linecap="round" class="transition-all duration-700"/>
                        </svg>
                        <span id="score-number" class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white">0</span>
                    </div>
                    <div class="text-[10px] font-mono">
                        <div class="text-pano-grey">CONFIDENCE</div>
                        <div id="score-status" class="text-pano-lime">GATHERING</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <span id="turn-counter" class="text-[10px] font-mono text-pano-grey hidden">TURN 0</span>
            <button onclick="location.reload()" class="text-xs font-medium text-pano-grey hover:text-white transition-colors border border-pano-border px-4 py-2 rounded-lg hover:border-pano-border-hover hover:bg-white/5">
                Reset
            </button>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full h-[2px] bg-pano-panel relative">
        <div id="ai-progress" class="h-full bg-gradient-to-r from-pano-lime to-pano-lime-soft transition-all duration-700 ease-out" style="width: 0%"></div>
    </div>

    <!-- Main Chat Area -->
    <main id="chat-history" class="flex-1 overflow-y-auto custom-scrollbar scroll-smooth">
        <div class="max-w-3xl mx-auto py-8 px-4 md:px-0 min-h-full flex flex-col justify-end">
            <div id="dynamic-content" class="space-y-6"></div>
            <div class="h-36"></div>
        </div>
    </main>

    <!-- Bottom Controls -->
    <div class="shrink-0 bg-gradient-to-t from-pano-bg via-pano-bg/95 to-transparent pt-12 pb-6 px-4 z-30">
        <div class="max-w-3xl mx-auto space-y-4">
            <!-- Options Container -->
            <div id="ai-options" class="flex flex-col gap-2 transition-all">
                <button onclick="handleOption('start', 'Begin Revenue Diagnostic')" class="msg-anim btn-option w-full text-left bg-pano-card border border-pano-border hover:border-pano-lime/50 p-5 rounded-xl transition-all group flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-pano-lime/10 flex items-center justify-center text-pano-lime">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z"></path>
                            </svg>
                        </div>
                        <span class="text-sm font-medium text-white">Begin Revenue Diagnostic</span>
                    </div>
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" class="text-pano-grey group-hover:text-pano-lime group-hover:translate-x-1 transition-all">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"></path>
                    </svg>
                </button>
            </div>

            <!-- Text Input Bar -->
            <div id="input-bar" class="relative group hidden opacity-0 transition-opacity duration-500">
                <div id="file-preview" class="absolute -top-14 left-0 bg-pano-card border border-pano-border px-4 py-2.5 rounded-xl flex items-center gap-3 hidden shadow-card">
                    <div class="flex items-center gap-2">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="text-pano-lime">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></path>
                        </svg>
                        <span class="text-xs text-pano-lime font-mono" id="file-name">FILE.PDF</span>
                    </div>
                    <button onclick="clearFile()" class="text-gray-500 hover:text-white transition-colors ml-2">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="bg-pano-card border border-pano-border rounded-xl flex items-center p-2 shadow-card focus-within:border-pano-lime/50 focus-within:shadow-glow-sm transition-all">
                    <input type="file" id="file-upload" class="hidden" accept="image/*,application/pdf,.doc,.docx" onchange="handleFileSelect(this)">
                    <button onclick="document.getElementById('file-upload').click()" class="p-3 text-gray-500 hover:text-pano-grey-light transition-colors rounded-lg hover:bg-white/5" title="Attach file">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13"></path>
                        </svg>
                    </button>
                    <input type="text" id="ai-text-input" 
                           class="flex-1 bg-transparent border-none text-white text-sm px-3 focus:ring-0 focus:outline-none placeholder:text-gray-600 h-10" 
                           placeholder="Type your response...">
                    <button onclick="handleTextSubmit()" class="p-2.5 bg-pano-lime text-black rounded-lg hover:bg-pano-lime-soft transition-all shadow-glow-sm hover:shadow-glow">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="text-center pt-2">
                <p class="text-[10px] text-gray-700 font-mono tracking-widest">PANORAMICA ENGINE v5.0 ‚Ä¢ MULTI-AGENT</p>
            </div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIGURATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const API_URL = "/api/chat";
        const REPORT_API_URL = "/api/report";
        const MAX_RETRIES = 3;
        const ALLOWED_MIME_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
        const MAX_FILE_SIZE = 15 * 1024 * 1024;

        // Phase mapping for display
        const PHASE_ORDER = ['welcome', 'company', 'gtm', 'sales', 'diagnosis', 'pre_finish', 'finish'];
        const PHASE_DISPLAY_MAP = {
            'welcome': 'phase-welcome',
            'company': 'phase-company',
            'gtm': 'phase-gtm',
            'sales': 'phase-sales',
            'diagnosis': 'phase-diagnosis',
            'pre_finish': 'phase-finish',
            'finish': 'phase-finish'
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE - Now includes sessionData from backend
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let conversationHistory = []; 
        let currentAttachment = null; 
        let isProcessing = false;
        let diagnosticData = {};
        
        // SESSION DATA - This is the key change: we persist and pass this to every API call
        let sessionData = null;
        
        // Current phase tracking
        let currentPhase = 'welcome';
        let turnCount = 0;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DOM ELEMENTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const chatHistoryMain = document.getElementById('chat-history');
        const dynamicContent = document.getElementById('dynamic-content');
        const optionsContainer = document.getElementById('ai-options');
        const inputBar = document.getElementById('input-bar');
        const progressBar = document.getElementById('ai-progress');
        const textInput = document.getElementById('ai-text-input');
        const modal = document.getElementById('context-modal');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const turnCounter = document.getElementById('turn-counter');
        const phaseDisplay = document.getElementById('phase-display');

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILITIES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function isValidURL(string) {
            try {
                const url = new URL(string);
                return url.protocol === "http:" || url.protocol === "https:";
            } catch (_) { return false; }
        }

        function sanitizeHTML(html) {
            const temp = document.createElement('div');
            temp.textContent = html;
            return temp.innerHTML;
        }

        function updateStatus(connected, message = '') {
            if (connected) {
                statusIndicator.className = 'w-1.5 h-1.5 bg-emerald-500 rounded-full';
                statusText.textContent = message || 'READY';
                statusText.className = 'text-[10px] text-pano-grey font-mono tracking-wider';
            } else {
                statusIndicator.className = 'w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse';
                statusText.textContent = message || 'ERROR';
                statusText.className = 'text-[10px] text-red-400 font-mono tracking-wider';
            }
        }

        function updateTurnCounter(turn) {
            turnCount = turn;
            turnCounter.classList.remove('hidden');
            turnCounter.textContent = `TURN ${turn}`;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE PROGRESS DISPLAY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function updatePhaseDisplay(phase, confidence) {
            phaseDisplay.classList.remove('hidden');
            currentPhase = phase;
            
            const phaseIndex = PHASE_ORDER.indexOf(phase);
            
            // Update each phase step
            PHASE_ORDER.forEach((p, idx) => {
                const elementId = PHASE_DISPLAY_MAP[p];
                const element = document.getElementById(elementId);
                if (!element) return;
                
                // Remove all state classes
                element.classList.remove('active', 'completed', 'pending');
                
                if (idx < phaseIndex) {
                    element.classList.add('completed');
                } else if (idx === phaseIndex) {
                    element.classList.add('active');
                } else {
                    element.classList.add('pending');
                }
            });
            
            // Update connectors
            for (let i = 1; i <= 5; i++) {
                const conn = document.getElementById(`conn-${i}`);
                if (!conn) continue;
                
                conn.classList.remove('completed', 'active', 'pending');
                
                if (i < phaseIndex) {
                    conn.classList.add('completed');
                } else if (i === phaseIndex) {
                    conn.classList.add('active');
                } else {
                    conn.classList.add('pending');
                }
            }
            
            // Update confidence score display
            if (confidence) {
                updateConfidenceScore(confidence);
            }
            
            // Update progress bar based on phase
            const progressPercent = Math.min((phaseIndex / (PHASE_ORDER.length - 1)) * 100, 100);
            progressBar.style.width = `${progressPercent}%`;
        }

        function updateConfidenceScore(confidence) {
            const circle = document.getElementById('score-circle');
            const number = document.getElementById('score-number');
            const status = document.getElementById('score-status');
            
            const score = confidence.total || 0;
            const circumference = 94.2;
            const offset = circumference - (score / 100) * circumference;
            
            circle.setAttribute('stroke-dasharray', `${circumference - offset} ${circumference}`);
            number.textContent = score;
            
            if (score >= 70) {
                status.textContent = 'READY';
                status.className = 'text-green-400';
            } else if (score >= 40) {
                status.textContent = 'BUILDING';
                status.className = 'text-yellow-400';
            } else {
                status.textContent = 'GATHERING';
                status.className = 'text-pano-lime';
            }
        }

        async function retryWithBackoff(fn, maxRetries = MAX_RETRIES) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.min(1000 * Math.pow(2, i), 10000);
                    console.log(`Retry ${i + 1}/${maxRetries} after ${delay}ms`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UI COMPONENTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'flex gap-4 msg-anim';
            indicator.innerHTML = `
                <div class="w-9 h-9 rounded-xl bg-pano-panel border border-pano-border flex items-center justify-center shrink-0">
                    <span class="text-pano-lime font-mono text-xs font-medium">RA</span>
                </div>
                <div class="flex gap-1.5 items-center bg-pano-card border border-pano-border px-6 py-4 rounded-2xl">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            dynamicContent.appendChild(indicator);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        function showLoadingState(message = 'Analyzing...') {
            optionsContainer.innerHTML = `
                <div class="w-full bg-pano-card border border-pano-border p-5 rounded-xl flex items-center gap-4">
                    <div class="w-5 h-5 border-2 border-pano-lime border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-xs font-mono text-pano-lime uppercase tracking-widest">${message}</span>
                </div>
            `;
        }

        function scrollToBottom() {
            requestAnimationFrame(() => {
                chatHistoryMain.scrollTo({ top: chatHistoryMain.scrollHeight, behavior: 'smooth' });
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MESSAGE RENDERING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function addUserMessage(text) {
            const div = document.createElement('div');
            div.className = "flex gap-4 flex-row-reverse msg-anim";
            div.innerHTML = `
                <div class="w-9 h-9 rounded-xl bg-pano-lime flex items-center justify-center shrink-0">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="text-black">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"></path>
                    </svg>
                </div>
                <div class="max-w-[80%]">
                    <div class="text-sm bg-pano-panel border border-pano-border p-4 rounded-2xl rounded-tr-md text-white">${sanitizeHTML(text)}</div>
                </div>
            `;
            dynamicContent.appendChild(div);
            scrollToBottom();
        }

        function addAIMessage(text) {
            if (!text) text = "Processing your request..."; 
            
            const div = document.createElement('div');
            div.className = "flex gap-4 msg-anim";
            
            let content;
            try {
                if (typeof marked !== 'undefined') {
                    marked.setOptions({ breaks: true, gfm: true });
                    content = marked.parse(text);
                } else {
                    content = text;
                }
            } catch (e) {
                content = sanitizeHTML(text);
            }

            div.innerHTML = `
                <div class="w-9 h-9 rounded-xl bg-pano-panel border border-pano-border flex items-center justify-center shrink-0">
                    <span class="text-pano-lime font-mono text-xs font-medium">RA</span>
                </div>
                <div class="flex-1 max-w-[85%]">
                    <div class="prose bg-pano-card border border-pano-border p-5 rounded-2xl rounded-tl-md shadow-card">${content}</div>
                </div>
            `;
            dynamicContent.appendChild(div);
            scrollToBottom();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MODAL HANDLERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function closeModalAndStartDemo() {
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.classList.add('hidden');
                addAIMessage("**Demo Mode Active**\n\nI'm the Revenue Architect ‚Äî a strategic advisor built to diagnose revenue bottlenecks.\n\nLet's begin your diagnostic session.");
                
                optionsContainer.innerHTML = '';
                const btn = document.createElement('button');
                btn.className = "msg-anim btn-option w-full text-left bg-pano-card border border-pano-border hover:border-pano-lime/50 p-4 rounded-xl transition-all group flex items-center justify-between";
                btn.onclick = () => handleOption('start_diagnostic', 'Start Diagnostic Session');
                btn.innerHTML = `
                    <span class="text-sm font-medium text-white">Start Diagnostic Session</span>
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" class="text-pano-grey group-hover:text-pano-lime group-hover:translate-x-1 transition-all shrink-0 ml-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"></path>
                    </svg>
                `;
                optionsContainer.appendChild(btn);
                
                updatePhaseDisplay('welcome', { total: 0 });
            }, 400);
        }

        async function handleContextSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-context');
            const website = document.getElementById('company-website').value.trim();
            const description = document.getElementById('company-description').value.trim();
            const linkedin = document.getElementById('company-linkedin').value.trim();
            const errorSpan = document.getElementById('website-error');

            if (!isValidURL(website)) {
                errorSpan.classList.remove('hidden');
                document.getElementById('company-website').focus();
                return;
            }
            errorSpan.classList.add('hidden');

            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <div class="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
                <span>Analyzing...</span>
            `;

            modal.style.opacity = '0';
            setTimeout(() => modal.classList.add('hidden'), 400);

            addAIMessage("**Initializing Analysis**\n\nScanning your digital footprint to build a company profile...");
            showLoadingState('SCANNING WEBSITE DATA...');
            updateStatus(true, 'SCANNING');
            updatePhaseDisplay('welcome', { total: 0 });

            try {
                const stepData = await retryWithBackoff(async () => {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 90000);
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            choice: "SNAPSHOT_INIT", 
                            history: [],
                            contextData: { website, description, linkedin },
                            sessionData: null  // First call, no session yet
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    return await response.json();
                });

                // Store diagnostic data
                diagnosticData = { website, description, linkedin };
                
                // CRITICAL: Store session data from response
                if (stepData.session_data) {
                    sessionData = stepData.session_data;
                    console.log('Session data initialized:', sessionData.currentPhase);
                }
                
                // Update phase display
                updatePhaseDisplay(
                    stepData.current_phase || 'company',
                    stepData.confidence_state || { total: 0 }
                );
                
                if (stepData.turn_count !== undefined) {
                    updateTurnCounter(stepData.turn_count);
                }
                
                conversationHistory.push({ role: "assistant", content: JSON.stringify(stepData) });
                renderTurn(stepData);
                updateStatus(true, 'READY');

            } catch (error) {
                console.error('Context initialization failed:', error);
                updateStatus(false, 'SCAN FAILED');
                optionsContainer.innerHTML = `
                    <button onclick="location.reload()" class="w-full text-red-400 border border-red-900/50 bg-red-900/10 p-5 rounded-xl hover:bg-red-900/20 transition-all flex items-center justify-center gap-3">
                        <span>Analysis failed. Click to retry.</span>
                    </button>
                `;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // OPTION HANDLING - Now passes sessionData
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function handleOption(key, explicitLabel = null) {
            if (isProcessing) return;
            
            // Handle report download
            if (key === 'download_report' || key === 'generate_report') { 
                downloadReport(); 
                return; 
            }

            isProcessing = true;
            let label = explicitLabel || key;
            if (currentAttachment) label += " üìé";

            addUserMessage(label);
            showTypingIndicator();
            showLoadingState('PROCESSING...');
            inputBar.classList.add('opacity-50', 'pointer-events-none');

            try {
                const stepData = await retryWithBackoff(async () => {
                    // CRITICAL: Include sessionData in every request
                    const payload = { 
                        choice: key, 
                        history: conversationHistory, 
                        attachment: currentAttachment,
                        sessionData: sessionData,  // Pass the session state
                        contextData: diagnosticData
                    };
                    
                    console.log('Sending request with session phase:', sessionData?.currentPhase);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 45000);
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    return await response.json();
                });

                clearFile();
                
                // CRITICAL: Update session data from response
                if (stepData.session_data) {
                    sessionData = stepData.session_data;
                    console.log('Session updated. Phase:', sessionData.currentPhase, 'Turn:', sessionData.turnCount);
                }
                
                // Update conversation history
                conversationHistory.push({ role: "user", content: `User selected: ${key}` });
                conversationHistory.push({ role: "assistant", content: JSON.stringify(stepData) });

                hideTypingIndicator();
                
                // Update phase display
                updatePhaseDisplay(
                    stepData.current_phase || sessionData?.currentPhase || currentPhase,
                    stepData.confidence_state || sessionData?.confidence || { total: 0 }
                );
                
                // Update turn counter
                if (stepData.turn_count !== undefined) {
                    updateTurnCounter(stepData.turn_count);
                } else if (sessionData?.turnCount !== undefined) {
                    updateTurnCounter(sessionData.turnCount);
                }
                
                renderTurn(stepData);
                updateStatus(true, 'READY');

            } catch (error) {
                console.error('API call failed:', error);
                hideTypingIndicator();
                updateStatus(false, 'CONNECTION ERROR');
                
                optionsContainer.innerHTML = `
                    <div class="text-red-400 p-5 text-center text-sm bg-red-900/10 border border-red-900/50 rounded-xl flex flex-col gap-3">
                        <span>Connection interrupted</span>
                        <button onclick="handleOption('${key}', '${label}')" class="bg-red-900/20 hover:bg-red-900/30 px-4 py-2 rounded-lg transition-colors">
                            Retry
                        </button>
                    </div>
                `;
            } finally {
                isProcessing = false;
            }
        }

        async function handleTextSubmit() {
            const text = textInput.value.trim();
            if (!text || isProcessing) return;
            textInput.value = '';
            await handleOption(text, text);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TURN RENDERING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderTurn(stepData) {
            console.log('renderTurn:', stepData.step_id, 'Phase:', stepData.current_phase);
            
            optionsContainer.innerHTML = '';
            inputBar.classList.remove('opacity-50', 'pointer-events-none');
            
            const msg = stepData.message || "What would you like to do next?";
            addAIMessage(msg);

            // Handle options
            let options = stepData.options;
            if (!options || !Array.isArray(options) || options.length === 0) {
                options = [
                    { key: "continue", label: "Continue" },
                    { key: "clarify", label: "Let me clarify something" }
                ];
            }

            options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.style.animationDelay = `${idx * 0.08}s`;
                btn.onclick = () => handleOption(opt.key, opt.label);
                
                // Special styling for report download button
                if (opt.key === 'download_report' || opt.key === 'generate_report') {
                    btn.className = "msg-anim w-full bg-pano-lime text-black border-2 border-pano-lime p-5 rounded-xl transition-all font-bold flex items-center justify-between shadow-glow hover:bg-pano-lime-soft hover:scale-[1.01]";
                    btn.innerHTML = `
                        <div class="flex items-center gap-3">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"></path>
                            </svg>
                            <span>${opt.label}</span>
                        </div>
                        <span class="text-sm opacity-70">PDF</span>
                    `;
                } else {
                    btn.className = "msg-anim btn-option w-full text-left bg-pano-card border border-pano-border hover:border-pano-lime/50 p-4 rounded-xl transition-all group flex items-center justify-between";
                    btn.innerHTML = `
                        <span class="text-sm font-medium text-white">${opt.label}</span>
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" class="text-pano-grey group-hover:text-pano-lime group-hover:translate-x-1 transition-all shrink-0 ml-3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"></path>
                        </svg>
                    `;
                }
                optionsContainer.appendChild(btn);
            });

            // Show text input
            if (stepData.mode === 'mixed' || stepData.allow_text !== false) {
                inputBar.classList.remove('hidden');
                setTimeout(() => {
                    inputBar.classList.remove('opacity-0');
                    textInput.focus();
                }, 100);
            } else {
                inputBar.classList.add('hidden', 'opacity-0');
            }

            scrollToBottom();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // REPORT DOWNLOAD
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function downloadReport() {
            if (isProcessing) return;
            isProcessing = true;

            showLoadingState('GENERATING STRATEGIC GROWTH PLAN...');
            updateStatus(true, 'GENERATING');

            try {
                const response = await fetch(REPORT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        history: conversationHistory,
                        sessionData: sessionData,
                        diagnosticData: diagnosticData
                    })
                });

                if (!response.ok) throw new Error(`Report API Error: ${response.status}`);

                const data = await response.json();
                
                if (data.pdf_base64) {
                    downloadBase64PDF(data.pdf_base64, data.filename || 'Strategic_Growth_Plan.pdf');
                } else if (data.report) {
                    await generateClientSidePDF(data.report, data.filename || 'Strategic_Growth_Plan');
                } else {
                    throw new Error('No report content');
                }

                addAIMessage("‚úÖ **Report Generated Successfully**\n\nYour Strategic Growth Plan has been downloaded.");
                
                optionsContainer.innerHTML = `
                    <button onclick="location.reload()" class="w-full btn-option bg-pano-card border border-pano-border hover:border-pano-lime/50 p-5 rounded-xl transition-all group flex items-center justify-between">
                        <span class="text-sm font-medium text-white">Start New Diagnostic</span>
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" class="text-pano-grey group-hover:text-pano-lime transition-colors">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"></path>
                        </svg>
                    </button>
                `;
                
                updatePhaseDisplay('finish', { total: 100 });
                updateStatus(true, 'COMPLETE');

            } catch (error) {
                console.error('Report download failed:', error);
                updateStatus(false, 'GENERATION FAILED');
                optionsContainer.innerHTML = `
                    <div class="text-red-400 p-5 text-center text-sm bg-red-900/10 border border-red-900/50 rounded-xl">
                        Failed to generate report. 
                        <button onclick="downloadReport()" class="underline hover:text-red-300 ml-1">Retry</button>
                    </div>
                `;
            } finally {
                isProcessing = false;
            }
        }

        function downloadBase64PDF(base64, filename) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'application/pdf' });
            
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        async function generateClientSidePDF(markdown, baseFilename) {
            // Simplified - use html2pdf
            const html = marked.parse(markdown);
            const container = document.createElement('div');
            container.innerHTML = `<div style="font-family: Arial, sans-serif; padding: 40px; max-width: 800px;">${html}</div>`;
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            document.body.appendChild(container);
            
            try {
                await html2pdf().set({
                    margin: 15,
                    filename: `${baseFilename}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).from(container).save();
            } finally {
                document.body.removeChild(container);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FILE HANDLING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function clearFile() {
            currentAttachment = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('file-preview').classList.add('hidden');
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            if (!ALLOWED_MIME_TYPES.includes(file.type)) {
                alert('File type not supported.');
                input.value = '';
                return;
            }

            if (file.size > MAX_FILE_SIZE) {
                alert(`File too large. Max: ${MAX_FILE_SIZE / 1024 / 1024}MB`);
                input.value = '';
                return;
            }

            const preview = document.getElementById('file-preview');
            preview.innerHTML = `<span class="text-xs text-pano-grey">Processing...</span>`;
            preview.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                currentAttachment = { 
                    mime_type: file.type, 
                    data: e.target.result.split(',')[1],
                    name: file.name
                };
                preview.innerHTML = `
                    <span class="text-xs text-pano-lime font-mono">${file.name.toUpperCase()}</span>
                    <button onclick="clearFile()" class="text-gray-500 hover:text-white transition-colors ml-2">‚úï</button>
                `;
            };
            reader.readAsDataURL(file);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EVENT LISTENERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        textInput.addEventListener("keypress", (e) => { 
            if (e.key === "Enter" && !e.shiftKey) { 
                e.preventDefault(); 
                handleTextSubmit(); 
            } 
        });

        window.addEventListener('beforeunload', (e) => {
            if (conversationHistory.length > 2) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
