<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panoramica AI - Consultant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { 
                extend: {
                    colors: {
                        'pano-lime': '#DCEE6A',
                        'pano-grey': '#9CA3AF',
                        'pano-dark': '#0A0A0A',
                        'pano-border': '#333333',
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: white; font-family: sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .chat-input:focus { outline: none; box-shadow: 0 0 0 2px #DCEE6A; }
        
        /* Markdown rendering basic */
        .bot-msg ul { list-style-type: disc; margin-left: 20px; margin-top: 5px; }
        .bot-msg strong { color: #DCEE6A; font-weight: bold; }
        .bot-msg a { color: #DCEE6A; text-decoration: underline; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="flex-none p-4 border-b border-pano-border bg-black/50 backdrop-blur-md z-10 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-pano-lime/10 flex items-center justify-center border border-pano-lime/30">
                <div class="w-3 h-3 bg-pano-lime rotate-45 shadow-[0_0_10px_#DCEE6A]"></div>
            </div>
            <span class="font-bold tracking-wide">Panoramica <span class="text-pano-lime">AI</span></span>
        </div>
        <a href="index.html" class="text-sm text-pano-grey hover:text-white transition">Exit Chat âœ•</a>
    </header>

    <main id="chat-container" class="flex-grow overflow-y-auto p-4 md:p-8 space-y-6 no-scrollbar relative">
        <div class="absolute inset-0 pointer-events-none flex items-center justify-center opacity-5">
             <div class="w-64 h-64 border border-white rotate-45"></div>
        </div>
    </main>

    <footer id="input-area" class="flex-none p-4 md:p-6 bg-[#050505] border-t border-pano-border">
        <div class="max-w-3xl mx-auto relative">
            <form id="chat-form" class="flex gap-4">
                <input type="text" id="user-input" 
                    class="w-full bg-[#111] border border-pano-border rounded-xl px-4 py-4 text-white placeholder-gray-500 focus:border-pano-lime transition outline-none shadow-lg"
                    placeholder="Type your answer here..." autocomplete="off">
                
                <button type="submit" id="send-btn" class="bg-pano-lime text-black p-4 rounded-xl hover:bg-white transition hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                    </svg>
                </button>
            </form>
            <div class="text-center mt-2">
                <p class="text-[10px] text-pano-grey uppercase tracking-widest">Powered by OpenAI GPT-4o</p>
            </div>
        </div>
    </footer>

    <script>
        // --- CONFIGURAZIONE ---
        // INCOLLA QUI IL LINK DEL TUO CLOUDFLARE WORKER (es. https://panoramica-bot.tuonome.workers.dev)
        const WORKER_URL = "https://odd-field-8d9b.giulioricciutipriv.workers.dev"; 
        // ---------------------

        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        // Storico della conversazione (per dare memoria al bot)
        let conversationHistory = [];

        // Funzione per aggiungere messaggi
        function addMessage(text, sender) {
            const msgDiv = document.createElement('div');
            const isBot = sender === 'bot';
            
            msgDiv.className = isBot 
                ? 'flex gap-4 max-w-3xl mx-auto animate-fade-in-up' 
                : 'flex gap-4 max-w-3xl mx-auto justify-end animate-fade-in-up';

            // Formattazione base del testo (converte a capo in <br>)
            let formattedText = text.replace(/\n/g, '<br>');
            // Rende cliccabili i link
            formattedText = formattedText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');

            if (isBot) {
                msgDiv.innerHTML = `
                    <div class="w-8 h-8 flex-shrink-0 rounded bg-pano-lime flex items-center justify-center mt-1">
                        <div class="w-2 h-2 bg-black rotate-45"></div>
                    </div>
                    <div class="bot-msg bg-[#1a1a1a] text-gray-200 p-4 rounded-2xl rounded-tl-none border border-pano-border/50 shadow-md leading-relaxed text-sm md:text-base">
                        ${formattedText}
                    </div>
                `;
            } else {
                msgDiv.innerHTML = `
                    <div class="bg-pano-lime/10 text-pano-lime border border-pano-lime/20 p-4 rounded-2xl rounded-tr-none shadow-[0_0_15px_rgba(220,238,106,0.1)] text-sm md:text-base">
                        ${formattedText}
                    </div>
                `;
            }
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
        }

        // Indicatore di caricamento
        let typingDivId = null;
        function showTyping() {
            typingDivId = 'typing-' + Date.now();
            const msgDiv = document.createElement('div');
            msgDiv.id = typingDivId;
            msgDiv.className = 'flex gap-4 max-w-3xl mx-auto animate-fade-in-up';
            msgDiv.innerHTML = `
                <div class="w-8 h-8 flex-shrink-0 rounded bg-pano-lime/50 flex items-center justify-center mt-1">
                    <div class="w-2 h-2 bg-black rotate-45 animate-spin"></div>
                </div>
                <div class="bg-[#1a1a1a] p-4 rounded-2xl rounded-tl-none border border-pano-border/50 flex gap-2 items-center h-[54px]">
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            `;
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
        }

        function removeTyping() {
            if (typingDivId) {
                document.getElementById(typingDivId).remove();
                typingDivId = null;
            }
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- INTEGRAZIONE API REALE ---
        async function handleUserMessage(text) {
            if (!text.trim()) return;

            // 1. Mostra messaggio utente
            addMessage(text, 'user');
            userInput.value = '';
            userInput.disabled = true;
            sendBtn.disabled = true;

            // 2. Aggiungi alla memoria
            conversationHistory.push({ role: "user", content: text });

            // 3. Mostra "sta scrivendo..."
            showTyping();

            try {
                // 4. Chiama il Backend
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: conversationHistory })
                });

                if (!response.ok) throw new Error("Server error");

                const data = await response.json();
                const aiReply = data.choices[0].message.content;

                // 5. Mostra risposta AI
                removeTyping();
                addMessage(aiReply, 'bot');
                
                // Aggiungi risposta AI alla memoria
                conversationHistory.push({ role: "assistant", content: aiReply });

            } catch (error) {
                removeTyping();
                addMessage("I'm having trouble connecting to the neural network. Please try again.", 'bot');
                console.error(error);
            }

            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
        }

        // --- AVVIO ---
        window.onload = () => {
            setTimeout(() => {
                addMessage("Hello. I am the Panoramica Revenue Architect AI. I'm here to analyze your infrastructure scalability.", 'bot');
                addMessage("To start, what is your name and which company are you representing?", 'bot');
            }, 800);
        };

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleUserMessage(userInput.value);
        });
    </script>
</body>
</html>
</html>
